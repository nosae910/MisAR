<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Missive AI Autodraft</title>
  
  <!-- Missive Integration Scripts -->
  <script src="https://integrations.missiveapp.com/missive.js"></script>
  <link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Lucide icons as inline SVG components
    const Loader2 = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
      </svg>
    );

    const Sparkles = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
        <path d="M5 3v4"/>
        <path d="M19 17v4"/>
        <path d="M3 5h4"/>
        <path d="M17 19h4"/>
      </svg>
    );

    const CheckCircle2 = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="m9 12 2 2 4-4"/>
      </svg>
    );

    const AlertCircle = ({ className }) => (
      <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" x2="12" y1="8" y2="12"/>
        <line x1="12" x2="12.01" y1="16" y2="16"/>
      </svg>
    );

    const MissiveAutodraft = () => {
      const [conversationId, setConversationId] = useState(null);
      const [conversationSubject, setConversationSubject] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [status, setStatus] = useState(null);
      const [webhookUrl, setWebhookUrl] = useState('');
      const [isConfiguring, setIsConfiguring] = useState(true);

      useEffect(() => {
        // Load saved webhook URL
        const loadConfig = async () => {
          try {
            const savedUrl = await window.Missive.storeGet('webhook_url');
            if (savedUrl) {
              setWebhookUrl(savedUrl);
              setIsConfiguring(false);
            }
          } catch (err) {
            console.log('No saved webhook URL');
          }
        };

        loadConfig();

        // Listen for conversation changes
        window.Missive.on('change:conversations', async (ids) => {
          if (ids.length === 1) {
            try {
              const conversations = await window.Missive.fetchConversations(ids);
              const conv = conversations[0];
              setConversationId(conv.id);
              setConversationSubject(conv.subject || 'No subject');
              setStatus(null);
            } catch (err) {
              console.error('Error fetching conversation:', err);
            }
          } else {
            setConversationId(null);
            setConversationSubject('');
            setStatus(null);
          }
        });
      }, []);

      const saveWebhookUrl = async () => {
        try {
          await window.Missive.storeSet('webhook_url', webhookUrl);
          setIsConfiguring(false);
          setStatus({ type: 'success', message: 'Webhook URL saved!' });
          setTimeout(() => setStatus(null), 2000);
        } catch (err) {
          setStatus({ type: 'error', message: 'Failed to save URL' });
        }
      };

      const generateDraft = async () => {
        if (!conversationId || !webhookUrl) return;

        setIsLoading(true);
        setStatus({ type: 'loading', message: 'Generating draft...' });

        try {
          const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              conversation: {
                id: conversationId
              },
              subject: conversationSubject,
              timestamp: new Date().toISOString(),
            }),
          });

          if (response.ok) {
            setStatus({ type: 'success', message: 'Draft generation started!' });
          } else {
            setStatus({ type: 'error', message: 'Webhook failed. Check your endpoint.' });
          }
        } catch (err) {
          setStatus({ type: 'error', message: 'Network error. Is your endpoint accessible?' });
        } finally {
          setIsLoading(false);
        }
      };

      if (isConfiguring) {
        return (
          <div className="p-4 space-y-4">
            <div className="space-y-2">
              <h2 className="text-lg font-semibold text-gray-900">Setup Autodraft</h2>
              <p className="text-sm text-gray-600">
                Enter your webhook endpoint URL to receive autodraft requests.
              </p>
            </div>

            <div className="space-y-2">
              <label className="block text-sm font-medium text-gray-700">
                Webhook URL
              </label>
              <input
                type="url"
                value={webhookUrl}
                onChange={(e) => setWebhookUrl(e.target.value)}
                placeholder="https://your-endpoint.com/autodraft"
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <button
              onClick={saveWebhookUrl}
              disabled={!webhookUrl}
              className="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
            >
              Save & Continue
            </button>

            <div className="mt-4 p-3 bg-blue-50 rounded-md">
              <p className="text-xs text-blue-900">
                <strong>Expected webhook payload:</strong>
              </p>
              <pre className="text-xs mt-2 text-blue-800 overflow-x-auto">
{`{
  "conversationId": "uuid",
  "subject": "Re: ...",
  "timestamp": "ISO 8601"
}`}
              </pre>
            </div>
          </div>
        );
      }

      return (
        <div className="p-4 space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <Sparkles className="w-5 h-5 text-purple-600" />
              AI Autodraft
            </h2>
            <button
              onClick={() => setIsConfiguring(true)}
              className="text-xs text-gray-500 hover:text-gray-700"
            >
              Configure
            </button>
          </div>

          {!conversationId ? (
            <div className="text-center py-8">
              <p className="text-sm text-gray-500">
                Select a conversation to generate a draft
              </p>
            </div>
          ) : (
            <div className="space-y-4">
              <div className="p-3 bg-gray-50 rounded-md">
                <p className="text-xs text-gray-500 mb-1">Current conversation</p>
                <p className="text-sm font-medium text-gray-900 truncate">
                  {conversationSubject}
                </p>
                <p className="text-xs text-gray-400 mt-1 font-mono">
                  {conversationId}
                </p>
              </div>

              <button
                onClick={generateDraft}
                disabled={isLoading}
                className="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-md hover:from-purple-700 hover:to-blue-700 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2 font-medium"
              >
                {isLoading ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    Generating...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-5 h-5" />
                    Generate AI Draft
                  </>
                )}
              </button>

              {status && (
                <div
                  className={`p-3 rounded-md flex items-start gap-2 ${
                    status.type === 'success'
                      ? 'bg-green-50 text-green-800'
                      : status.type === 'error'
                      ? 'bg-red-50 text-red-800'
                      : 'bg-blue-50 text-blue-800'
                  }`}
                >
                  {status.type === 'success' ? (
                    <CheckCircle2 className="w-5 h-5 flex-shrink-0 mt-0.5" />
                  ) : status.type === 'error' ? (
                    <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                  ) : (
                    <Loader2 className="w-5 h-5 flex-shrink-0 mt-0.5 animate-spin" />
                  )}
                  <p className="text-sm">{status.message}</p>
                </div>
              )}

              <div className="mt-6 pt-4 border-t border-gray-200">
                <details className="text-xs text-gray-600">
                  <summary className="cursor-pointer hover:text-gray-900 font-medium">
                    How it works
                  </summary>
                  <ul className="mt-2 space-y-1 list-disc list-inside">
                    <li>Select any conversation (private or shared)</li>
                    <li>Click "Generate AI Draft" button</li>
                    <li>Webhook sends conversation ID to your endpoint</li>
                    <li>Your backend creates the draft via Missive API</li>
                  </ul>
                </details>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Render the app
    ReactDOM.render(<MissiveAutodraft />, document.getElementById('root'));
  </script>
</body>
</html>
